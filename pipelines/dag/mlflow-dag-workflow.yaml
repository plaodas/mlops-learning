apiVersion: argoproj.io/v1alpha1
kind: Workflow
metadata:
  name: mlflow-dag
  namespace: argo
spec:
  entrypoint: pipeline
  templates:

  - name: pipeline
    dag:
      tasks:
      - name: preprocess
        template: preprocess

      - name: train
        template: train
        dependencies: [preprocess]
        arguments:
          artifacts:
          - name: preprocessed
            from: "{{tasks.preprocess.outputs.artifacts.preprocessed}}"

      - name: evaluate
        template: evaluate
        dependencies: [train]
        arguments:
          artifacts:
          - name: model
            from: "{{tasks.train.outputs.artifacts.model}}"
          - name: preprocessed
            from: "{{tasks.preprocess.outputs.artifacts.preprocessed}}"

  - name: preprocess
    container:
      image: localhost:5001/mlflow-dag:latest
      imagePullPolicy: IfNotPresent
      command: ["/bin/sh", "-c", "mkdir -p /outputs && python /preprocess.py"]
    outputs:
      artifacts:
      - name: preprocessed
        path: /outputs/preprocessed.csv

  - name: train
    inputs:
      artifacts:
      - name: preprocessed
        path: /inputs/preprocessed.csv
    container:
      image: localhost:5001/mlflow-dag:latest
      imagePullPolicy: IfNotPresent
      command: ["/bin/sh", "-c", "mkdir -p /outputs && python /train.py"]
    outputs:
      artifacts:
      - name: model
        path: /outputs/model.pkl

  - name: evaluate
    inputs:
      artifacts:
      - name: model
        path: /inputs/model.pkl
      - name: preprocessed
        path: /inputs/preprocessed.csv
    container:
      image: localhost:5001/mlflow-dag:latest
      imagePullPolicy: IfNotPresent
      command: ["/bin/sh", "-c", "mkdir -p /outputs && python /evaluate.py"]

